<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Msg page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
    body {
        background: radial-gradient(circle at top left, rgba(30,144,255,0.4), transparent 60%),
                    radial-gradient(circle at bottom right, rgba(138,43,226,0.4), transparent 60%),
                    radial-gradient(circle at center, #0a0a6b, #1b2a49 70%, #000000);
        background-attachment: fixed;
        background-image: radial-gradient(rgba(255,255,255,0.07) 1px, transparent 1px),
                          radial-gradient(circle at top left, rgba(30,144,255,0.4), transparent 60%),
                          radial-gradient(circle at bottom right, rgba(138,43,226,0.4), transparent 60%),
                          radial-gradient(circle at center, #0a0a6b, #1b2a49 70%, #000000);
        background-size: 40px 40px, auto, auto, auto;
        color: white;
        height: 100vh;
        margin: 0;
        display: flex;
        flex-direction: column;
    }
    .navbar { padding-top: 1.5rem; padding-bottom: 1.5rem; }

    #confIndicator { display: flex; justify-content: space-between; margin-top: 1rem; max-width: 250px; margin-left: auto; margin-right: auto; }
    .conf-badge-wrapper { display: flex; flex-direction: column; align-items: center; font-size: 0.8rem; color: #aaa; }
    .conf-badge { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; transition: background-color 0.4s ease; margin-bottom: 6px; }
    .conf-badge.high { background-color: #f8d7da; }
    .conf-badge.medium { background-color: #fff3cd; }
    .conf-badge.low { background-color: #d1e7dd; }
    .conf-badge.high.active { background-color: #dc3545; box-shadow: 0 0 12px #dc3545; }
    .conf-badge.medium.active { background-color: #ffc107; box-shadow: 0 0 12px #ffc107; }
    .conf-badge.low.active { background-color: #198754; box-shadow: 0 0 12px #198754; }

    #confAlerts { max-width: 350px; margin: 10px auto 0 auto; font-size: 0.9rem; }
    .conf-alert { display: none; padding: 0.5rem 1rem; border-radius: 0.25rem; margin-top: 6px; }
    .conf-alert.active { display: block; }
    .conf-alert.high { background-color: #fca5a5; color: #7f1d1d; }
    .conf-alert.medium { background-color: #fef9c3; color: #665c00; }
    .conf-alert.low { background-color: #bbf7d0; color: #14532d; }

    #hashContainer { margin-top: 25px; }
    #hashContainer h5 { color: white; font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
    #hashValue { width: 100%; height: 100px; background-color: white; color: black; font-size: 0.9rem; font-family: monospace; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #ced4da; resize: none; }
    #sendMessageContainer { max-width: 350px; margin: 20px auto 60px auto; text-align: center; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg bg-body-tertiary">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="#"><h3 class="mb-0">CrypticComm</h3></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="/homepage">Home</a></li>
        <li class="nav-item position-relative">
          <a class="nav-link" href="/inboxpage">
            Inbox
            <span id="inboxBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
              {{ message_count|default:0 }}
              <span class="visually-hidden">unread messages</span>
            </span>
          </a>
        </li>
      </ul>
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link text-danger fw-bold" href="/logoutpage">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">
  <label for="floatingInputGroup1" class="fw-bold text-white">Enter mail id</label>
  <small class="text-white-50 d-block mb-1">(enter the mail id of the receiver to send the message)</small>
  <div class="input-group mb-1">
    <span class="input-group-text">@</span>
    <div class="form-floating flex-grow-1">
      <input list="registeredEmailsList" type="text" class="form-control text-muted" id="floatingInputGroup1" placeholder="Email ID" />
      <label for="floatingInputGroup1" class="text-black">Email ID</label>
      <datalist id="registeredEmailsList">
        {% for email in user_emails %}<option value="{{ email }}">{% endfor %}
      </datalist>
    </div>
  </div>
</div>

<div class="container mt-4">
  <label for="messageInput" class="fw-bold mb-1 text-white">Enter your confidential message here</label>
  <textarea class="form-control" id="messageInput" placeholder="Enter your confidential message here" style="height: 100px;"></textarea>
  <small class="text-white-50 d-block mb-1">(to check the confidentiality submit your message)</small>

  <button type="button" id="submitBtn" class="btn btn-success mt-3 d-block mx-auto">Submit</button>

  <div id="confIndicator">
    <div class="conf-badge-wrapper"><span class="conf-badge high" id="highConf"></span><span>High</span></div>
    <div class="conf-badge-wrapper"><span class="conf-badge medium" id="mediumConf"></span><span>Medium</span></div>
    <div class="conf-badge-wrapper"><span class="conf-badge low" id="lowConf"></span><span>Low</span></div>
  </div>

  <div id="confAlerts">
    <div id="alertHigh" class="conf-alert high"></div>
    <div id="alertMedium" class="conf-alert medium"></div>
    <div id="alertLow" class="conf-alert low"></div>
  </div>

  <div id="hashContainer">
    <h5>Hash Value</h5>
    <textarea id="hashValue" readonly></textarea>
  </div>

  <div id="sendMessageContainer">
    <button id="sendMessageBtn" class="btn btn-success btn-lg" style="margin-top: 25px;">Send Message</button>
  </div>
</div>

<script>
const registeredEmails = {{ user_emails|safe }}.map(e => e.toLowerCase());
let inboxCount = {{ message_count|default:0 }};
let lastLevel = "low";

document.addEventListener("DOMContentLoaded", () => {
    const badge = document.getElementById("inboxBadge");
    badge.textContent = inboxCount || 0;
});

async function generateHash(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,"0")).join("");
}

async function classifyConfidentiality(message) {
    const response = await fetch("/ml/classify/", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "message=" + encodeURIComponent(message)
    });
    const data = await response.json();
    return { level: (data.mapped_conf || "low").toLowerCase(), encryption: data.encryption || "Fernet" };
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";").map(c => c.trim());
        for (let cookie of cookies) {
            if (cookie.startsWith(name + "=")) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; }
        }
    }
    return cookieValue;
}

document.getElementById("submitBtn").addEventListener("click", async () => {
    const emailInput = document.getElementById("floatingInputGroup1").value.trim().toLowerCase();
    const message = document.getElementById("messageInput").value.trim();
    if (!emailInput) { alert("Please enter an email address."); return; }
    if (!registeredEmails.includes(emailInput)) { alert("This email is not registered."); return; }
    if (!message) { alert("Please enter a confidential message."); return; }

    const result = await classifyConfidentiality(message);
    lastLevel = result.level;
    const encryption = result.encryption;

    ["highConf","mediumConf","lowConf"].forEach(id => document.getElementById(id).classList.remove("active"));
    ["alertHigh","alertMedium","alertLow"].forEach(id => { document.getElementById(id).classList.remove("active"); document.getElementById(id).innerHTML = ""; });

    if (lastLevel==="high"){ document.getElementById("highConf").classList.add("active"); document.getElementById("alertHigh").classList.add("active"); document.getElementById("alertHigh").innerHTML=`Message confidentiality: <strong>High</strong>.<br/>Encryption: ${encryption}`;}
    else if(lastLevel==="medium"){ document.getElementById("mediumConf").classList.add("active"); document.getElementById("alertMedium").classList.add("active"); document.getElementById("alertMedium").innerHTML=`Message confidentiality: <strong>Medium</strong>.<br/>Encryption: ${encryption}`;}
    else{ document.getElementById("lowConf").classList.add("active"); document.getElementById("alertLow").classList.add("active"); document.getElementById("alertLow").innerHTML=`Message confidentiality: <strong>Low</strong>.<br/>Encryption: ${encryption}`;}

    document.getElementById("hashValue").value = await generateHash(message);
});

document.getElementById("sendMessageBtn").addEventListener("click", async () => {
    const emailInput = document.getElementById("floatingInputGroup1").value.trim().toLowerCase();
    const message = document.getElementById("messageInput").value.trim();
    const hash = document.getElementById("hashValue").value.trim();
    if(!emailInput || !message){ 
        Swal.fire("â ï¸ Missing Data","Please enter both email and message before sending.","warning");
        return; 
    }

    try {
        const response = await fetch("/send_message/", {
            method:"POST",
            headers:{ "Content-Type":"application/json", "X-CSRFToken": getCookie("csrftoken")},
            body: JSON.stringify({ 
                receiver: emailInput, 
                message: message, 
                hash: hash,
                classification: lastLevel
            })
        });
        if(response.ok){ 
            inboxCount++;
            document.getElementById("inboxBadge").textContent = inboxCount;
            Swal.fire({
              title: "â Message Sent!",
              text: "Your message was sent successfully.",
              icon: "success",
              confirmButtonText: "OK",
              confirmButtonColor: "#6f42c1"
            });
        }
        else{ 
            const error=await response.json(); 
            Swal.fire("â Failed",""+(error.error||"Unknown error"),"error");
        }
    } catch(err){ 
        Swal.fire("â Error",""+err,"error");
    }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
